name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Native x86_64 builds
  build-linux:
    name: linux - x86_64
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install Build Dependencies
        run: apk add --no-cache gcc musl-dev git

      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: Alpine Linux"
          echo "Architecture: x86_64"
          uname -a
          gcc --version

      - name: Bootstrap Prism
        run: gcc -o /tmp/prism prism.c

      - name: Self-Install
        run: |
          /tmp/prism install
          rm -f /tmp/prism

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine x86_64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

  build-macos-intel:
    name: macos - x86_64
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: macOS"
          echo "Architecture: x86_64"
          uname -a
          clang --version

      - name: Bootstrap Prism
        run: clang -o /tmp/prism prism.c

      - name: Self-Install
        run: |
          /tmp/prism install
          rm -f /tmp/prism

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from macOS x86_64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

  build-macos-arm:
    name: macos - arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: macOS"
          echo "Architecture: arm64"
          uname -a
          clang --version

      - name: Bootstrap Prism
        run: clang -o /tmp/prism prism.c

      - name: Self-Install
        run: |
          /tmp/prism install
          rm -f /tmp/prism

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from macOS arm64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

  # Multi-arch Alpine builds via QEMU
  build-arm64:
    name: linux - arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build and Test in Alpine ARM64
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            alpine:latest sh -c '
              apk add --no-cache gcc musl-dev
              echo "Architecture: $(uname -m)"
              gcc --version
              gcc -o /tmp/prism prism.c
              /tmp/prism install
              rm -f /tmp/prism
              which prism
              prism || true
              cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine arm64!\n"); return 0; }
          EOF
              prism test_hello.c
              prism run .github/test.c
            '

  build-riscv:
    name: linux - riscv64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Build and Test in Alpine RISC-V
        run: |
          docker run --rm --platform linux/riscv64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            alpine:edge sh -c '
              apk add --no-cache gcc musl-dev
              echo "Architecture: $(uname -m)"
              gcc --version
              gcc -o /tmp/prism prism.c
              /tmp/prism install
              rm -f /tmp/prism
              which prism
              prism || true
              cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine riscv64!\n"); return 0; }
          EOF
              prism test_hello.c
              prism run .github/test.c
            '
