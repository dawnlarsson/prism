name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Native x86_64 builds
  build-linux:
    name: linux - x86_64
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install Build Dependencies
        run: apk add --no-cache gcc musl-dev git

      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: Alpine Linux"
          echo "Architecture: x86_64"
          uname -a
          gcc --version

      - name: "Stage 0: Build with host compiler"
        run: gcc -o /tmp/prism_stage0 prism.c

      - name: "Stage 1: Prism builds itself"
        run: /tmp/prism_stage0 prism.c -o /tmp/prism_stage1

      - name: "Stage 2: Self-built Prism builds itself again"
        run: /tmp/prism_stage1 prism.c -o /tmp/prism_stage2

      - name: Install Stage 2
        run: |
          /tmp/prism_stage2 install
          rm -f /tmp/prism_stage0 /tmp/prism_stage1 /tmp/prism_stage2

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine x86_64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

      - name: Run Library Mode Tests
        run: |
          gcc -DPRISM_LIB_MODE -o test_lib .github/test_lib.c
          ./test_lib

  build-macos-intel:
    name: macos - x86_64
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: macOS"
          echo "Architecture: x86_64"
          uname -a
          clang --version

      - name: "Stage 0: Build with host compiler"
        run: clang -o /tmp/prism_stage0 prism.c

      - name: "Stage 1: Prism builds itself"
        run: /tmp/prism_stage0 prism.c -o /tmp/prism_stage1

      - name: "Stage 2: Self-built Prism builds itself again"
        run: /tmp/prism_stage1 prism.c -o /tmp/prism_stage2

      - name: Install Stage 2
        run: |
          /tmp/prism_stage2 install
          rm -f /tmp/prism_stage0 /tmp/prism_stage1 /tmp/prism_stage2

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from macOS x86_64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

      - name: Run Library Mode Tests
        run: |
          clang -DPRISM_LIB_MODE -o test_lib .github/test_lib.c
          ./test_lib

  build-macos-arm:
    name: macos - arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Display System Info
        run: |
          echo "OS: macOS"
          echo "Architecture: arm64"
          uname -a
          clang --version

      - name: "Stage 0: Build with host compiler"
        run: clang -o /tmp/prism_stage0 prism.c

      - name: "Stage 1: Prism builds itself"
        run: /tmp/prism_stage0 prism.c -o /tmp/prism_stage1

      - name: "Stage 2: Self-built Prism builds itself again"
        run: /tmp/prism_stage1 prism.c -o /tmp/prism_stage2

      - name: Install Stage 2
        run: |
          /tmp/prism_stage2 install
          rm -f /tmp/prism_stage0 /tmp/prism_stage1 /tmp/prism_stage2

      - name: Verify Installation
        run: |
          which prism
          prism || true

      - name: Test Build Functionality
        run: |
          cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from macOS arm64!\n"); return 0; }
          EOF
          prism test_hello.c

      - name: Run Test Suite
        run: prism run .github/test.c

      - name: Run Library Mode Tests
        run: |
          clang -DPRISM_LIB_MODE -o test_lib .github/test_lib.c
          ./test_lib

  build-windows:
    name: windows - x86_64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Display System Info
        run: |
          echo "OS: Windows"
          echo "Architecture: x86_64"
          cl 2>&1 | head -1

      - name: Bootstrap Prism
        run: cl /Fe:prism.exe prism.c /nologo /O2 /D_CRT_SECURE_NO_WARNINGS

      - name: Verify Build
        run: .\prism.exe --version

  # Multi-arch Alpine builds via QEMU
  build-arm64:
    name: linux - arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build and Test in Alpine ARM64
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            alpine:latest sh -c '
              apk add --no-cache gcc musl-dev
              echo "Architecture: $(uname -m)"
              gcc --version
              echo "=== Stage 0: Build with host compiler ==="
              gcc -o /tmp/prism_stage0 prism.c
              echo "=== Stage 1: Prism builds itself ==="
              /tmp/prism_stage0 prism.c -o /tmp/prism_stage1
              echo "=== Stage 2: Self-built Prism builds itself again ==="
              /tmp/prism_stage1 prism.c -o /tmp/prism_stage2
              /tmp/prism_stage2 install
              rm -f /tmp/prism_stage0 /tmp/prism_stage1 /tmp/prism_stage2
              which prism
              prism || true
              cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine arm64!\n"); return 0; }
          EOF
              prism test_hello.c
              prism run .github/test.c
              gcc -DPRISM_LIB_MODE -o test_lib .github/test_lib.c
              ./test_lib
            '

  build-riscv:
    name: linux - riscv64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Build and Test in Alpine RISC-V
        run: |
          docker run --rm --platform linux/riscv64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            alpine:edge sh -c '
              apk add --no-cache gcc musl-dev
              echo "Architecture: $(uname -m)"
              gcc --version
              echo "=== Stage 0: Build with host compiler ==="
              gcc -o /tmp/prism_stage0 prism.c
              echo "=== Stage 1: Prism builds itself ==="
              /tmp/prism_stage0 prism.c -o /tmp/prism_stage1
              echo "=== Stage 2: Self-built Prism builds itself again ==="
              /tmp/prism_stage1 prism.c -o /tmp/prism_stage2
              /tmp/prism_stage2 install
              rm -f /tmp/prism_stage0 /tmp/prism_stage1 /tmp/prism_stage2
              which prism
              prism || true
              cat <<EOF > test_hello.c
          #include <stdio.h>
          int main() { printf("Hello from Alpine riscv64!\n"); return 0; }
          EOF
              prism test_hello.c
              prism run .github/test.c
              gcc -DPRISM_LIB_MODE -o test_lib .github/test_lib.c
              ./test_lib
            '
